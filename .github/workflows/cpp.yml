name: C++

# TODO: add file patterns with recursive glob **
on:
  - push
  - pull_request

jobs:
  build:
    name: Linux
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - conda-cpp
          - debian-cpp
          - ubuntu-cpp
          - fedora-cpp
        include:
          - service: conda-cpp
            conda: latest
          - service: debian-cpp
            debian: 10
          - service: ubuntu-cpp
            ubuntu: 14.04
          - service: ubuntu-cpp
            ubuntu: 16.04
          - service: ubuntu-cpp
            ubuntu: 18.04
          - service: fedora-cpp
            fedora: 29

    env:
      ORG: docker.pkg.github.com/${{ github.repository }}
      CONDA: ${{ matrix.conda || 'latest' }}
      DEBIAN: ${{ matrix.debian || '10' }}
      UBUNTU: ${{ matrix.ubuntu || '18.04' }}
      FEDORA: ${{ matrix.fedora || '29' }}

    steps:
      - name: Checkout Arrow
        uses: actions/checkout@v1
        with:
          submodules: true
      - name: Diagnostics
        run: |
          docker version
          env
      - name: Docker Login
        run: |
          docker login docker.pkg.github.com \
            -u ${{ github.actor }} \
            -p ${{ secrets.GITHUB_PACKAGES_TOKEN }}
      - name: Docker Pull
        run: docker-compose pull --ignore-pull-failures ${{ matrix.service }}
      - name: Docker Build
        run: docker-compose build ${{ matrix.service }}
      - name: Docker Run
        run: docker-compose run ${{ matrix.service }}
      - name: Docker Push
        run: docker-compose push ${{ matrix.service }}
