# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# The environment variables referenced from this docker-compose can be set by
# defining them before running docker-compose, the defaults are set in .env
# file.
#
# Example:
# $ ARCH=arm64v8 docker-compose build ubuntu-bionic-cpp
# $ ARCH=arm64v8 docker-compose run ubuntu-bionic-cpp

version: '3.5'

# TODO(kszucs): include ARCH to cache as well
volumes:
  conda-latest-cache:
  cuda-10.0-cache:
  debian-10-cache:
  ubuntu-18.04-cache:
  ubuntu-16.04-cache:
  ubuntu-14.04-cache:
  fedora-29-cache:
  maven-cache:

services:

  ################################# C++ #######################################
  # Release build:
  #   docker-compose build -e ARROW_BUILD_TYPE=release conda-cpp|debian-cpp|...
  # Shared only:
  #   docker-compose build -e ARROW_BUILD_STATIC=OFF conda-cpp|debian-cpp|...
  # Static only:
  #   docker-compose build \
  #     -e ARROW_BUILD_SHARED=OFF \
  #     -e ARROW_TEST_LINKAGE=static \
  #     conda-cpp|debian-cpp|...
  # Minimum boost - Ubuntu Xenial 16.04 has Boost 1.58:
  #   UBUNTU=16.04 docker-compose build \
  #     -e ARROW_BOOST_SOURCE=SYSTEM \
  #     ubuntu-cpp

  conda-cpp:
    image: ${ORG}/${ARCH}-conda-latest-cpp:latest
    build:
      context: ci
      dockerfile: docker/conda-latest-cpp.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-conda-latest-cpp:latest
      args:
        arch: ${ARCH}
        conda: latest
        prefix: /opt/conda
    shm_size: &shm-size 2G
    volumes: &conda-volumes
      - .:/arrow:delegated
      - conda-latest-cache:/build:delegated
    command: &cpp-command >
      /bin/bash -c "
        /arrow/ci/scripts/cpp_build.sh /arrow /build/cpp &&
        /arrow/ci/scripts/cpp_test.sh  /arrow /build/cpp"

  cuda-cpp:
    # only amd64 is supported
    image: ${ORG}/${ARCH}-cuda-${CUDA}-cpp:latest
    build:
      context: ci
      dockerfile: docker/cuda-${CUDA}-cpp.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-cuda-${CUDA}-cpp:latest
    shm_size: *shm-size
    volumes: &cuda-volumes
      - .:/arrow:delegated
      - cuda-${CUDA}-cache:/build:delegated
    command: *cpp-command

  debian-cpp:
    image: ${ORG}/${ARCH}-debian-${DEBIAN}-cpp:latest
    build:
      context: ci
      dockerfile: docker/debian-${DEBIAN}-cpp.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-${DEBIAN}-cpp:latest
      args:
        arch: ${ARCH}
    shm_size: *shm-size
    volumes: &debian-volumes
      - .:/arrow:delegated
      - debian-${DEBIAN}-cache:/build:delegated
    command: *cpp-command

  ubuntu-cpp:
    # Possible architectures: amd64, arm64v8
    # Possible distros: 18.04, 16.04, 14.04
    image: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-cpp:latest
    build:
      context: ci
      dockerfile: docker/ubuntu-${UBUNTU}-cpp.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-ubuntu-${UBUNTU}-cpp:latest
      args:
        arch: ${ARCH}
    shm_size: *shm-size
    volumes: &ubuntu-volumes
      - .:/arrow:delegated
      - ubuntu-${UBUNTU}-cache:/build:delegated
    command: *cpp-command

  fedora-cpp:
    image: ${ORG}/${ARCH}-fedora-${FEDORA}-cpp:latest
    build:
      context: ci
      dockerfile: docker/fedora-${FEDORA}-cpp.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-fedora-${FEDORA}-cpp:latest
      args:
        arch: ${ARCH}
    shm_size: *shm-size
    volumes: &fedora-volumes
      - .:/arrow:delegated
      - fedora-${FEDORA}-cache:/build:delegated
    command: *cpp-command

  ############################### C GLib ######################################

  debian-c-glib:
    image: ${ORG}/${ARCH}-debian-${DEBIAN}-c-glib:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-c-glib.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-${DEBIAN}-c-glib:latest
      args:
        base: ${ORG}/${ARCH}-debian-${DEBIAN}-cpp:latest
    shm_size: *shm-size
    volumes: *debian-volumes
    command: &c-glib-command >
      /bin/bash -c "
        /arrow/ci/scripts/cpp_build.sh /arrow /build/cpp &&
        /arrow/ci/scripts/c_glib_build.sh /arrow /build/c_glib &&
        /arrow/ci/scripts/c_glib_test.sh /arrow /build/c_glib"

  ubuntu-c-glib:
    image: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-c-glib:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-c-glib.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-ubuntu-${UBUNTU}-c-glib:latest
      args:
        base: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-cpp:latest
    shm_size: *shm-size
    volumes: *ubuntu-volumes
    command: *c-glib-command

  ############################### Python ######################################

  conda-python:
    image: ${ORG}/${ARCH}-conda-latest-python-${PYTHON}:latest
    build:
      context: ci
      dockerfile: docker/conda-latest-python.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-conda-latest-python-${PYTHON}:latest
      args:
        org: ${ORG}
        arch: ${ARCH}
        conda: latest
        python: ${PYTHON}
    shm_size: *shm-size
    volumes: *conda-volumes
    command: &python-command >
      /bin/bash -c "
        /arrow/ci/scripts/cpp_build.sh /arrow /build/cpp &&
        /arrow/ci/scripts/python_build.sh /arrow &&
        /arrow/ci/scripts/python_test.sh /arrow"

  cuda-python:
    image: ${ORG}/${ARCH}-cuda-${CUDA}-python-3:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-python-3.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-cuda-${CUDA}-python-3:latest
      args:
        base: ${ORG}/${ARCH}-cuda-${CUDA}-cpp:latest
    shm_size: *shm-size
    volumes: *cuda-volumes
    command: *python-command

  debian-python:
    image: ${ORG}/${ARCH}-debian-${DEBIAN}-python-3:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-python-3.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-${DEBIAN}-python-3:latest
      args:
        base: ${ORG}/${ARCH}-debian-${DEBIAN}-cpp:latest
    shm_size: *shm-size
    volumes: *debian-volumes
    command: *python-command

  ubuntu-python:
    image: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-python-3:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-python-3.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-ubuntu-${UBUNTU}-python-3:latest
      args:
        base: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-cpp:latest
    shm_size: *shm-size
    volumes: *ubuntu-volumes
    command: *python-command

  fedora-python:
    image: ${ORG}/${ARCH}-fedora-${FEDORA}-python-3:latest
    build:
      context: ci
      dockerfile: docker/linux-dnf-python-3.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-fedora-${FEDORA}-python-3:latest
      args:
        base: ${ORG}/${ARCH}-fedora-${FEDORA}-cpp:latest
    shm_size: *shm-size
    volumes: *fedora-volumes
    command: *python-command

  ############################# Python Pandas #################################

  conda-python-pandas:
    image: ${ORG}/${ARCH}-conda-latest-python-${PYTHON}-pandas-${PANDAS}:latest
    build:
      context: ci
      dockerfile: docker/conda-latest-python-pandas.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-conda-latest-python-${PYTHON}-pandas-${PANDAS}:latest
      args:
        org: ${ORG}
        arch: ${ARCH}
        conda: latest
        python: ${PYTHON}
        pandas: ${PANDAS}
    shm_size: *shm-size
    volumes: *conda-volumes
    command: *python-command

  ################################## R ########################################

  conda-r:
    image: ${ORG}/${ARCH}-conda-latest-r-${R}:latest
    build:
      context: ci
      dockerfile: docker/conda-latest-r.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-conda-latest-r-${R}:latest
      args:
        org: ${ORG}
        arch: ${ARCH}
        conda: latest
        r: ${R}
    shm_size: *shm-size
    volumes: *conda-volumes
    command: &r-command >
      /bin/bash -c "
        /arrow/ci/scripts/cpp_build.sh /arrow /build/cpp &&
        /arrow/ci/scripts/r_build.sh /arrow &&
        /arrow/ci/scripts/r_build.sh /arrow"

  ubuntu-r:
    image: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-r-3.6:latest
    build:
      context: ci
      dockerfile: docker/linux-apt-r-3.6.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-ubuntu-${UBUNTU}-r-3.6:latest
      args:
        base: ${ORG}/${ARCH}-ubuntu-${UBUNTU}-cpp:latest
    shm_size: *shm-size
    volumes: *ubuntu-volumes
    command: *r-command

  ################################ Rust #######################################

  debian-rust:
    image: ${ORG}/${ARCH}-debian-10-rust-${RUST}:latest
    build:
      context: ci
      dockerfile: docker/debian-10-rust.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-10-rust-${RUST}:latest
      args:
        arch: ${ARCH}
        rust: ${RUST}
    shm_size: *shm-size
    volumes: *debian-volumes
    command: &rust-command >
      /bin/bash -c "
        /arrow/ci/scripts/rust_build.sh /arrow /build/rust &&
        /arrow/ci/scripts/rust_test.sh /arrow /build/rust"

  ################################# Go ########################################

  debian-go:
    image: ${ORG}/${ARCH}-debian-10-go-${GO}:latest
    build:
      context: ci
      dockerfile: docker/debian-10-go.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-10-go-${GO}:latest
      args:
        arch: ${ARCH}
        go: ${GO}
    shm_size: *shm-size
    volumes: *debian-volumes
    command: &go-command >
      /bin/bash -c "
        /arrow/ci/scripts/go_build.sh /arrow &&
        /arrow/ci/scripts/go_test.sh /arrow"

  ############################# JavaScript ####################################

  debian-js:
    image: ${ORG}/${ARCH}-debian-10-js-${NODE}:latest
    build:
      context: ci
      dockerfile: docker/debian-10-js.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-10-js-${NODE}:latest
      args:
        arch: ${ARCH}
        node: ${NODE}
    shm_size: *shm-size
    volumes: *debian-volumes
    command: &js-command >
      /bin/bash -c "
        /arrow/ci/scripts/js_build.sh /arrow &&
        /arrow/ci/scripts/js_test.sh /arrow"

  ################################ Java #######################################

  debian-java:
    image: ${ORG}/${ARCH}-debian-10-java-${JDK}-maven-${MAVEN}:latest
    build:
      context: ci
      dockerfile: docker/debian-10-java.dockerfile
      cache_from:
        - ${ORG}/${ARCH}-debian-10-java-${JDK}-maven-${MAVEN}:latest
      args:
        arch: ${ARCH}
        jdk: ${JDK}
        maven: ${MAVEN}
    shm_size: *shm-size
    volumes: &java-volumes
      - .:/arrow:delegated
      - maven-cache:/root/.m2:delegated
    command: &java-command >
      /bin/bash -c "
        /arrow/ci/scripts/java_build.sh /arrow &&
        /arrow/ci/scripts/java_test.sh /arrow"
